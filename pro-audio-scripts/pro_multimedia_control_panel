#!/bin/bash
# ==============================================================================
# Universal Pro-Audio Control Panel (v6.1) - "The IRQ & Hybrid Fix"
# ==============================================================================

# 1. CONFIGURATION
RT_PRIO_USB=97       # Scarlett 2i2
RT_PRIO_AUDIO=95     # PipeWire
RT_PRIO_DAW=93       # Reaper / Plugins
RT_PRIO_WINE=91      # Wineserver
RT_PRIO_NVIDIA=70    # GPU

declare -A RESTORE_PRIORITIES=( ["xhci_hcd"]=0 ["nvidia"]=0 ["nvme"]=0 )
notify() { echo -e "[INFO] $1"; }

# ---------------------------------------------------------
# 2. SCHED-EXT HANDLING (Stop then Start - No Switch)
# ---------------------------------------------------------
cpu_sched_apply() {
    local action=$1; local sched=$2; local mode=$3
    if [[ "$action" == "stop" ]]; then
        sudo scxctl stop 2>/dev/null && notify "SCHED-EXT: BPF scheduler stopped."
        return 0
    fi
    [[ -z "$sched" || -z "$mode" ]] && { echo "[ERROR] Sched-ext requires -s and -m."; return 1; }

    # Per instructions: Stop then Start (never use 'switch')
    notify "SCHED-EXT: Resetting scheduler slot..."
    sudo scxctl stop 2>/dev/null
    sleep 0.5
    notify "SCHED-EXT: Starting $sched ($mode)..."
    sudo scxctl start --sched "$sched" --mode "$mode" && notify "SCHED-EXT: $sched is now ACTIVE."
}

# ---------------------------------------------------------
# 3. TOPOLOGY & TUNING
# ---------------------------------------------------------
manage_cstates() {
    if [[ "$1" == "on" ]]; then
        sudo cpupower idle-set -D 0 >/dev/null 2>&1
        notify "CPU: C-States DISABLED (Sleep prevention active)."
    else
        sudo cpupower idle-set -E >/dev/null 2>&1
        notify "CPU: C-States ENABLED."
    fi
}

get_p_cores() {
    local max_freq=$(cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq 2>/dev/null | sort -nr | head -n1)
    [[ -z "$max_freq" ]] && { echo "0-$(($(nproc) - 1))"; return; }
    grep -l "$max_freq" /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq | grep -oP 'cpu\K[0-9]+' | sort -n | xargs | tr ' ' ','
}

apply_audio_settings() {
    [[ -n "$1" ]] && pw-metadata -n settings 0 clock.force-quantum "$1" >/dev/null 2>&1
    [[ -n "$2" ]] && pw-metadata -n settings 0 clock.force-rate "$2" >/dev/null 2>&1
    notify "AUDIO: PipeWire reconfigured to $1 @ $2 Hz."
}

boost_daw_instant() {
    local p_cores=$(get_p_cores)
    local all_targets=$(pgrep -f "reaper|yabridge|wineserver|\.exe" | grep -v "oom_reaper")

    for pid in $all_targets; do
        local target_prio=$RT_PRIO_DAW
        [[ $(ps -p "$pid" -o comm=) == "wineserver" ]] && target_prio=$RT_PRIO_WINE

        sudo taskset -pc "$p_cores" "$pid" > /dev/null 2>&1
        sudo chrt -f -p "$target_prio" "$pid" 2>/dev/null

        for thread in /proc/"$pid"/task/*; do
            [ -e "$thread" ] && sudo chrt -f -p "$target_prio" "${thread##*/}" 2>/dev/null
        done
    done
    notify "BOOST: DAW stack optimized."
}

# ---------------------------------------------------------
# 4. SYSTEM OPTIMIZATION & DIAGNOSTICS
# ---------------------------------------------------------
system_optimize() {
    if [[ "$1" == "on" ]]; then
        echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null
        command -v nvidia-settings &>/dev/null && nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=1" > /dev/null 2>&1

        # Pin and Elevate IRQs: Scarlett (USB) on Core 0 | NVIDIA on Core 2
        pgrep -f "irq/.*-xhci_hcd" | xargs -r -I {} sudo sh -c "taskset -pc 0 {} && chrt -f -p $RT_PRIO_USB {}" >/dev/null 2>&1
        pgrep -f "irq/.*-nvidia" | xargs -r -I {} sudo sh -c "taskset -pc 2 {} && chrt -f -p $RT_PRIO_NVIDIA {}" >/dev/null 2>&1

        echo "never" | sudo tee /sys/kernel/mm/transparent_hugepage/enabled > /dev/null
        echo 10 | sudo tee /proc/sys/vm/swappiness > /dev/null
        notify "SYSTEM: Performance mode ACTIVE."
    else
        local fb="powersave"
        grep -q "schedutil" /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors && fb="schedutil"
        echo "$fb" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null
        pgrep -f "irq/" | xargs -r -I {} sudo taskset -pc "0-$(($(nproc)-1))" {} >/dev/null
        notify "SESSION ENDED: Defaults restored."
    fi
}

check_status() {
    echo "================================================================"
    echo "    SYSTEM AUDIO STATUS REPORT"
    echo "================================================================"
    echo -e "PipeWire:    Buffer: $(pw-metadata -n settings 0 clock.force-quantum | grep -oP 'value:\K.*') | Rate: $(pw-metadata -n settings 0 clock.force-rate | grep -oP 'value:\K.*')"
    echo -e "CPU Gov:     $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"
    echo -e "Memory:      Swappiness: $(cat /proc/sys/vm/swappiness) | HugePages: $(cat /sys/kernel/mm/transparent_hugepage/enabled | grep -o '\[.*\]')"
    echo "Audio Stack (RT):"
    ps -eo rtprio,comm | awk '$1 > 0 && $2 !~ /idle_inject|ktimers|rcu|watchdog|migration|oom_reaper/ {print "            - " $2 " (Prio: " $1 ")"}' | sort -u | grep -Ei "reaper|yabridge|wine|pipewire|jack" || echo "            None active."
    echo "Hardware IRQs (RT):"
    ps -eo rtprio,psr,comm | grep -Ei "xhci|nvidia" | awk '$1 > 0 {print "            - " $3 " (Prio: " $1 " | Core: " $2 ")"}' | sort -u || echo "            Standard Priority (0)."
    echo "================================================================"
}

# ---------------------------------------------------------
# 5. EXECUTION & MONITORING
# ---------------------------------------------------------
launch_and_monitor() {
    local path="$1"
    [[ "$OPT_STATE" == "on" ]] && system_optimize "on"
    [[ "$CSTATE_STATE" == "on" ]] && manage_cstates "on"

    notify "LAUNCHING DAW: $path"
    env WINEFSYNC=1 "$path" &

    while ! pgrep -f "$(basename "$path")" > /dev/null; do sleep 1; done
    sleep 5
    boost_daw_instant "$path"
    while pgrep -x "$(basename "$path")" > /dev/null; do sleep 2; done

    notify "DAW Closed. Cleaning up..."
    [[ "$OPT_STATE" == "on" ]] && system_optimize "off"
    [[ "$CSTATE_STATE" == "on" ]] && manage_cstates "off"
    sudo scxctl stop 2>/dev/null
}

usage() {
    echo "Usage: sudo WINEFSYNC=1 $0 [OPTIONS]"
    echo "  -o on|off     System Perf (CPU/GPU)"
    echo "  -c on|off     Toggle C-States"
    echo "  -b [frames]   Buffer size"
    echo "  -r [hz]       Sample Rate"
    echo "  -d [path]     DAW path"
    echo "  -a start|stop SCX action"
    echo "  -s [name]     SCX scheduler"
    echo "  -m [mode]     SCX mode"
    echo "  -S            Status check"
    echo "  -h            Help"
    exit 0
}

# ---------------------------------------------------------
# 6. MAIN FLOW
# ---------------------------------------------------------
[[ $# -eq 0 ]] && usage

while getopts "o:c:b:r:d:a:s:m:Sh" opt; do
    case "$opt" in
        o) OPT_STATE=$OPTARG ;;
        c) CSTATE_STATE=$OPTARG ;;
        b) AUDIO_BUFFER=$OPTARG ;;
        r) AUDIO_SAMPLE_RATE=$OPTARG ;;
        d) DAW_PATH=$OPTARG ;;
        a) CLI_ACTION=$OPTARG ;;
        s) CLI_SCHED=$OPTARG ;;
        m) CLI_MODE=$OPTARG ;;
        S) STATUS_CHECK=true ;;
        h) usage ;;
        *) usage ;;
    esac
done

[[ -n "$AUDIO_BUFFER" || -n "$AUDIO_SAMPLE_RATE" ]] && apply_audio_settings "$AUDIO_BUFFER" "$AUDIO_SAMPLE_RATE"
[[ -n "$CLI_ACTION" ]] && cpu_sched_apply "$CLI_ACTION" "$CLI_SCHED" "$CLI_MODE"

if [[ -n "$DAW_PATH" ]]; then
    launch_and_monitor "$DAW_PATH"
else
    [[ -n "$OPT_STATE" ]] && system_optimize "$OPT_STATE"
    [[ -n "$CSTATE_STATE" ]] && manage_cstates "$CSTATE_STATE"
fi

[[ "$STATUS_CHECK" == true ]] && check_status
