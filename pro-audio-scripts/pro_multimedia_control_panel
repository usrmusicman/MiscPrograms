#!/bin/bash
# Arch Linux Multimedia Control Center (Pure CLI - Sudo Version)
# Optimized for Scarlett 2i2, 12700K (P/E-core jitter), and Pro Audio

# ----------------------------
# CONFIGURATION & STATE
# ----------------------------
WIFI_STATE_FILE="/tmp/pro-audio-control-wifi.state"
buffers=("32" "48" "64" "96" "128" "192" "256" "512" "1024" "2048")
rates=("44100" "48000" "88200" "96000")

notify() {
    echo -e "[INFO] $1"
}

# ----------------------------
# C-States (CPU Latency) Management
# ----------------------------
manage_cstates() {
    # 0 = Always Active (No sleep), 2000 = Standard (Allow deep sleep)
    local state=$1
    if [[ "$state" == "on" ]]; then
        # Writing 0 to cpu_dma_latency blocks all C-states except C0
        if [[ -e /dev/cpu_dma_latency ]]; then
            # We use a background exec to keep the file descriptor open,
            # otherwise the kernel resets it when the script exits.
            # For a CLI toggle, we use the sysfs pm_qos interface if available,
            # but for a simple bash toggle, we will use the force_cpuidle_latency.
            if [[ -d /sys/devices/system/cpu/cpu0/cpuidle ]]; then
                for d in /sys/devices/system/cpu/cpu*/cpuidle/state*/disable; do
                    echo 1 | sudo tee "$d" > /dev/null
                done
                notify "CPU: C-States DISABLED (All cores locked to C0)."
            fi
        fi
    else
        if [[ -d /sys/devices/system/cpu/cpu0/cpuidle ]]; then
            for d in /sys/devices/system/cpu/cpu*/cpuidle/state*/disable; do
                echo 0 | sudo tee "$d" > /dev/null
            done
            notify "CPU: C-States ENABLED (Standard power saving restored)."
        fi
    fi
}

# ----------------------------
# CPU Scheduler Logic (scx)
# ----------------------------
get_valid_schedulers() {
    local raw
    raw=$(scxctl list 2>/dev/null | grep "supported schedulers:")
    if [[ -z "$raw" ]]; then
        VALID_SCHEDS=("bpfland" "flash" "lavd" "p2dq" "tickless" "rusty")
    else
        VALID_SCHEDS=($(echo "$raw" | sed -E 's/.*\[\s*"?(.*)"?\s*\].*/\1/' | tr ',' ' ' | tr -d '"'))
    fi
}

cpu_sched_apply() {
    local action=$1; local sched=$2; local mode=$3
    [[ -z "$sched" || -z "$mode" ]] && return 1
    sudo scxctl "$action" --sched "$sched" --mode "$mode" && \
        notify "CPU scheduler set to $sched ($mode)."
}

cpu_sched_stop() {
    sudo scxctl stop && notify "CPU scheduler stopped."
}

# ----------------------------
# Hardware & Kernel Optimization
# ----------------------------
manage_wifi_latency() {
    if [[ "$1" == "boost" ]]; then
        iw dev | grep "Power save: on" > /dev/null && echo "on" > "$WIFI_STATE_FILE" || echo "off" > "$WIFI_STATE_FILE"
        notify "NET: Disabling Wi-Fi Power Management"
        sudo iw dev wlan0 set power_save off 2>/dev/null
    else
        [[ "$(cat "$WIFI_STATE_FILE" 2>/dev/null)" == "on" ]] && sudo iw dev wlan0 set power_save on 2>/dev/null
        rm -f "$WIFI_STATE_FILE"
        notify "NET: Restored Wi-Fi State"
    fi
}

boost_usb_irqs() {
    notify "IRQ: Prioritizing USB threads for Audio Interface"
    local usb_pids=$(pgrep "irq/.*-usb")
    if [[ -n "$usb_pids" ]]; then
        for pid in $usb_pids; do
            sudo chrt -f -p 95 "$pid"
        done
    fi
}

system_optimize() {
    local state=$1
    if [[ "$state" == "on" ]]; then
        echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null
        if command -v nvidia-settings &>/dev/null; then
            nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=1" > /dev/null 2>&1
        fi
        echo "never" | sudo tee /sys/kernel/mm/transparent_hugepage/enabled > /dev/null
        echo 10 | sudo tee /proc/sys/vm/swappiness > /dev/null
        echo 100 | sudo tee /proc/sys/vm/vfs_cache_pressure > /dev/null
        echo 3072 | sudo tee /sys/class/rtc/rtc0/max_user_freq > /dev/null
        manage_wifi_latency "boost"
        boost_usb_irqs
        [[ $(command -v rtirq) ]] && sudo rtirq restart
        notify "SYSTEM: Kernel/Hardware optimizations enabled."
    else
        echo "schedutil" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null
        echo "always" | sudo tee /sys/kernel/mm/transparent_hugepage/enabled > /dev/null
        echo 60 | sudo tee /proc/sys/vm/swappiness > /dev/null
        manage_wifi_latency "restore"
        notify "SYSTEM: Restored to Balanced/Eco Mode."
    fi
}

apply_audio_settings() {
    local buffer=$1; local rate=$2

    if [[ -n "$buffer" ]]; then
        if pw-metadata -n settings 0 clock.force-quantum "$buffer" >/dev/null 2>&1; then
            notify "AUDIO: Buffer -> $buffer"
        else
            echo "[ERROR] PipeWire unreachable."
        fi
    fi
    if [[ -n "$rate" ]]; then
        pw-metadata -n settings 0 clock.force-rate "$rate" >/dev/null 2>&1
        notify "AUDIO: Rate -> $rate"
    fi
}

check_status() {
    echo "--- System Status ---"
    echo "CPU Governor:    $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"

    # Check if C-States are disabled (checking if state1 is disabled is a good proxy)
    local cstate_status="Enabled (Power Saving)"
    [[ -e /sys/devices/system/cpu/cpu0/cpuidle/state1/disable && $(cat /sys/devices/system/cpu/cpu0/cpuidle/state1/disable) == "1" ]] && cstate_status="Disabled (Low Latency)"
    echo "C-States:        $cstate_status"

    echo "Swappiness:      $(cat /proc/sys/vm/swappiness)"
    echo "Hugepages:       $(grep -o "\[.*\]" /sys/kernel/mm/transparent_hugepage/enabled | tr -d '[]')"
    echo "Wi-Fi Power:     $(iw dev wlan0 get power_save 2>/dev/null | awk '{print $NF}' || echo "N/A")"

    local lat=$(pw-metadata -n settings 0 2>/dev/null | grep -E 'clock.force-(quantum|rate)' | awk '{print $3}' | xargs echo | sed 's/ /\//')
    echo "PipeWire Latency: ${lat:-Default (Auto)}"
    echo "---------------------"
}

# ----------------------------
# CLI Argument Parsing
# ----------------------------
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "System Commands (Kernel/Hardware):"
    echo "  -o on|off             Toggle performance mode (CPU, GPU, THP, Wi-Fi, IRQ)"
    echo "  -c on|off             Toggle C-States (on=disabled for low latency, off=enabled)"
    echo ""
    echo "Audio Server Commands (PipeWire):"
    echo "  -b [frames]           Set audio buffer (e.g., 128). Use 0 to reset."
    echo "  -r [hz]                Set sample rate (e.g., 48000). Use 0 to reset."
    echo ""
    echo "Scheduler Commands:"
    echo "  -a start|switch|stop  CPU Scheduler (scxctl) action"
    echo "  -s [scheduler]        Select scx scheduler (e.g., lavd)"
    echo "  -m [mode]             Select scheduler mode (e.g., gaming)"
    echo ""
    echo "General:"
    echo "  --status              Show current system optimization status"
    echo "  -l sched|buffer|rate  List available options"
    echo "  -h                    Show this help menu"
    exit 0
}

[[ $# -eq 0 ]] && usage

for arg in "$@"; do
    if [[ "$arg" == "--status" ]]; then check_status; exit 0; fi
done

while getopts "o:c:b:r:s:m:a:l:h" opt; do
    case "$opt" in
        o) OPT_STATE=$OPTARG ;;
        c) CSTATE_STATE=$OPTARG ;;
        b) AUDIO_BUFFER=$OPTARG ;;
        r) AUDIO_SAMPLE_RATE=$OPTARG ;;
        s) CLI_SCHED=$OPTARG ;;
        m) CLI_MODE=$OPTARG ;;
        a) CLI_ACTION=$OPTARG ;;
        l)
            case "$OPTARG" in
                sched) get_valid_schedulers; echo "${VALID_SCHEDS[@]}" | tr ' ' '\n' ;;
                buffer) echo "${buffers[@]}" | tr ' ' '\n' ;;
                rate) echo "${rates[@]}" | tr ' ' '\n' ;;
            esac
            exit 0 ;;
        h|*) usage ;;
    esac
done

if [[ -n "$AUDIO_BUFFER" || -n "$AUDIO_SAMPLE_RATE" ]]; then
    apply_audio_settings "$AUDIO_BUFFER" "$AUDIO_SAMPLE_RATE"
fi

if [[ -n "$OPT_STATE" ]]; then
    system_optimize "$OPT_STATE"
fi

if [[ -n "$CSTATE_STATE" ]]; then
    manage_cstates "$CSTATE_STATE"
fi

if [[ -n "$CLI_ACTION" ]]; then
    [[ "$CLI_ACTION" == "stop" ]] && cpu_sched_stop || cpu_sched_apply "$CLI_ACTION" "$CLI_SCHED" "$CLI_MODE"
fi
