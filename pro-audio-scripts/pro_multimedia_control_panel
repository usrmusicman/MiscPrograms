#!/bin/bash
# Arch Linux Multimedia Control Center
# Optimized for Scarlett 2i2, Nvidia/AMD, and Pro Audio
# Dependencies: scx-scheds-git, pipewire, pkexec, kdialog/zenity, rtirq

# ----------------------------
# GUI Detection
# ----------------------------
if command -v kdialog &>/dev/null; then
    GUI="kdialog"
elif command -v zenity &>/dev/null; then
    GUI="zenity"
else
    echo "No GUI tool available (kdialog or zenity required)."
    exit 1
fi

notify() {
    local msg="$1"
    if [[ "$GUI" == "kdialog" ]]; then
        kdialog --passivepopup "$msg" 4
    else
        zenity --info --text="$msg" --timeout=4
    fi
}

# ----------------------------
# CPU Scheduler Logic (scx)
# ----------------------------
VALID_MODES=("auto" "gaming" "powersave" "lowlatency" "server")

get_valid_schedulers() {
    local raw
    raw=$(scxctl list 2>/dev/null | grep "supported schedulers:")
    if [[ -z "$raw" ]]; then
        VALID_SCHEDS=("bpfland" "flash" "lavd" "p2dq" "tickless" "rusty")
    else
        VALID_SCHEDS=($(echo "$raw" | sed -E 's/.*\[\s*"?(.*)"?\s*\].*/\1/' | tr ',' ' ' | tr -d '"'))
    fi
}

cpu_menu() {
    if [[ "$GUI" == "kdialog" ]]; then
        CPU_CONFIG_MENU=$(kdialog --combobox "CPU Schedule Control" "Start" "Switch" "Stop")
    else
        CPU_CONFIG_MENU=$(zenity --list --title="CPU Schedule Control" --column="Options" "Start" "Switch" "Stop")
    fi
}

scheduler_menu() {
    get_valid_schedulers
    if [[ "$GUI" == "kdialog" ]]; then
        SCHEDULER_CHOICE=$(kdialog --combobox "Select CPU scheduler" "${VALID_SCHEDS[@]}")
        MODE_CHOICE=$(kdialog --combobox "Select scheduler profile" "${VALID_MODES[@]}")
    else
        SCHEDULER_CHOICE=$(zenity --list --title="Select CPU scheduler" --column="Schedulers" "${VALID_SCHEDS[@]}")
        MODE_CHOICE=$(zenity --list --title="Select scheduler profile" --column="Profiles" "${VALID_MODES[@]}")
    fi
}

cpu_sched_apply() {
    local action=$1
    [[ -z "$SCHEDULER_CHOICE" || -z "$MODE_CHOICE" ]] && return 1

    # Elevation required for scxctl
    pkexec scxctl "$action" --sched "$SCHEDULER_CHOICE" --mode "$MODE_CHOICE" && \
        notify "CPU scheduler set to $SCHEDULER_CHOICE ($MODE_CHOICE)."
}

cpu_sched_stop() {
    pkexec scxctl stop && notify "CPU scheduler stopped."
}

run_scxctl() {
    cpu_menu
    case "$CPU_CONFIG_MENU" in
        Start|Switch)
            scheduler_menu
            cpu_sched_apply "${CPU_CONFIG_MENU,,}"
            ;;
        Stop)
            cpu_sched_stop
            ;;
    esac
}

# ----------------------------
# Hardware Optimization (Governor/GPU/IRQ)
# ----------------------------
cpu_boost() {
    local gov_file="/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors"
    local target_gov=""

    if [[ "$1" == "on" ]]; then
        target_gov="performance"
    else
        grep -q "schedutil" "$gov_file" && target_gov="schedutil" || target_gov="powersave"
    fi

    # Using pkexec for sysfs writes
    echo "$target_gov" | pkexec tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null
    notify "CPU Governor: $target_gov"
}

gpu_boost() {
    local mode=$1
    if command -v nvidia-settings &>/dev/null; then
        # Nvidia-settings usually works as user if X is running, but Mizer needs rights
        if [[ "$mode" == "on" ]]; then
            nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=1" > /dev/null 2>&1
        else
            nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=0" > /dev/null 2>&1
        fi
    elif [[ -d /sys/class/drm/card0/device ]]; then
        local amd_path="/sys/class/drm/card0/device/power_dpm_force_performance_level"
        if [[ -f "$amd_path" ]]; then
            local val=$([[ "$mode" == "on" ]] && echo "high" || echo "auto")
            echo "$val" | pkexec tee "$amd_path" > /dev/null
        fi
    fi
}

system_optimize() {
    local state=$1
    if [[ "$state" == "on" ]]; then
        # PipeWire metadata does NOT need root (user level daemon)
        pw-metadata -n settings 0 clock.force-quantum "$AUDIO_BUFFER" > /dev/null
        pw-metadata -n settings 0 clock.force-rate "$AUDIO_SAMPLE_RATE" > /dev/null

        cpu_boost "on"
        gpu_boost "on"

        # IRQ and Modprobe require elevation
        [[ $(command -v rtirq) ]] && pkexec rtirq restart
        lsmod | grep -q snd_hrtimer || pkexec modprobe snd_hrtimer

        notify "PRO MODE: $AUDIO_BUFFER / $AUDIO_SAMPLE_RATE Locked."
    else
        pw-metadata -n settings 0 clock.force-quantum 0 > /dev/null
        pw-metadata -n settings 0 clock.force-rate 0 > /dev/null
        cpu_boost "off"
        gpu_boost "off"
        notify "ECO MODE: Balanced power restored."
    fi
}

# ----------------------------
# Launch & Selection
# ----------------------------
buffers=("32" "48" "64" "96" "128" "192" "256" "512" "1024" "2048")
rates=("44100" "48000" "88200" "96000")

select_buffer_rate() {
    if [[ "$GUI" == "kdialog" ]]; then
        AUDIO_BUFFER=$(kdialog --combobox "Select Buffer (Frames)" "${buffers[@]}")
        AUDIO_SAMPLE_RATE=$(kdialog --combobox "Select Sample Rate" "${rates[@]}")
    else
        AUDIO_BUFFER=$(zenity --list --title="Buffer" --column="Frames" "${buffers[@]}")
        AUDIO_SAMPLE_RATE=$(zenity --list --title="Rate" --column="Hz" "${rates[@]}")
    fi
    [[ -z "$AUDIO_BUFFER" ]] && AUDIO_BUFFER=1024
    [[ -z "$AUDIO_SAMPLE_RATE" ]] && AUDIO_SAMPLE_RATE=48000
}

launch_daw() {
    local default_env="WINEFSYNC=1 WINESYNC=1"

    if [[ "$GUI" == "kdialog" ]]; then
        ENVIRONMENT_VARS=$(kdialog --inputbox "Env Vars:" "$default_env")
        DAW_PATH=$(kdialog --getopenfilename "/" "Select DAW Executable")
    else
        ENVIRONMENT_VARS=$(zenity --entry --title="Env Vars" --entry-text="$default_env")
        DAW_PATH=$(zenity --file-selection --title="Select DAW Executable")
    fi

    # Exit if user cancelled file selection
    [[ -z "$DAW_PATH" ]] && return

    select_buffer_rate
    system_optimize "on"

    if [[ -x "$DAW_PATH" && ! -d "$DAW_PATH" ]]; then
        export PIPEWIRE_LATENCY="$AUDIO_BUFFER/$AUDIO_SAMPLE_RATE"
        # Run DAW as user, but with optimized environment
        eval "${ENVIRONMENT_VARS} pw-jack -s $AUDIO_SAMPLE_RATE -p $AUDIO_BUFFER \"$DAW_PATH\"" &
    else
        notify "Error: Executable not found."
        system_optimize "off"
    fi
}

# ----------------------------
# Main Loop
# ----------------------------
while true; do
    if [[ "$GUI" == "kdialog" ]]; then
        MAIN_MENU=$(kdialog --combobox "Arch Audio Control" "Launch DAW (Auto-Optimize)" "Change CPU Schedulers (scxctl)" "Manual Optimization ON" "Manual Optimization OFF" "Exit")
    else
        MAIN_MENU=$(zenity --list --title="Arch Audio Control" --column="Options" "Launch DAW (Auto-Optimize)" "Change CPU Schedulers (scxctl)" "Manual Optimization ON" "Manual Optimization OFF" "Exit")
    fi

    case "$MAIN_MENU" in
        "Launch DAW (Auto-Optimize)") launch_daw ;;
        "Change CPU Schedulers (scxctl)") run_scxctl ;;
        "Manual Optimization ON") select_buffer_rate; system_optimize "on" ;;
        "Manual Optimization OFF") system_optimize "off" ;;
        Exit|*) system_optimize "off"; break ;;
    esac
done
