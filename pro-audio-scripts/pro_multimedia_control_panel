#!/usr/bin/env bash
# ==============================================================================
# PRO-AUDIO CONTROL PANEL (v8.0) - "The Root-Compatible Variant"
# ==============================================================================

# 1. CONFIGURATION & PRIORITIES
RT_PRIO_NVIDIA=97
RT_PRIO_USB=95
RT_PRIO_BT=93
RT_PRIO_AUDIO=91
RT_PRIO_DAW=93
RT_PRIO_WINE=91
SWAPPINESS_TARGET=10

# 2. RESTORATION SETTINGS
RESTORE_RT_PRIO_IRQ=50
RESTORE_RT_PRIO_PROC=0
RESTORE_SWAPPINESS=60

# Identify the actual user to fix PipeWire root issues
REAL_USER=${SUDO_USER:-$USER}

notify() { echo -e "\033[1;35m[PRO-AUDIO]\033[0m $1"; }

# ---------------------------------------------------------
# 3. HELP MENU
# ---------------------------------------------------------
show_help() {
    echo -e "\033[1;32mPRO-AUDIO CONTROL PANEL v7.9\033[0m"
    echo -e "--------------------------------------------------------------------------------"
    echo -e "\033[1;33mCORE COMMANDS:\033[0m"
    echo -e "  -o on             \033[1;36m[OPTIMIZE]\033[0m Engages RT priorities, Performance Govs,"
    echo -e "                    GPU PowerMizer, and Network Latency tweaks."
    echo -e "  -o off            \033[1;36m[RESTORE]\033[0m Reverts all IRQs, priorities, and system"
    echo -e "                    settings to safe default values (RESTORE_RT_PRIO)."
    echo -e "  -c on|off         \033[1;36m[C-STATES]\033[0m Toggle CPU sleep states independently."
    echo -e "  -S                \033[1;36m[STATUS]\033[0m Detailed report of active RT priorities,"
    echo -e "                    core pinning, and hardware state."
    echo -e ""
    echo -e "\033[1;33mPIPEWIRE & SCHEDULER TUNING:\033[0m"
    echo -e "  -b [frames]       Force Quantum (Buffer). Example: -b 128"
    echo -e "  -r [hz]           Force Sample Rate.   Example: -r 48000"
    echo -e "  -s [name]         Custom SCX Scheduler (Defaults to scx_lavd)"
    echo -e "  -m [mode]         SCX Scheduler Mode    (Defaults to gaming)"
    echo -e ""
    echo -e "\033[1;33mSYSTEM MODULES EXPLAINED:\033[0m"
    echo -e "  \033[1;37m• CPU & Kernel:\033[0m  Switches to Performance Gov, disables THP, and"
    echo -e "                    sets Swappiness to 10 for lower disk I/O interference."
    echo -e "  \033[1;37m• Hardware IRQ:\033[0m  Isolates Scarlett USB to Core 0 and Nvidia to Core 2"
    echo -e "                    with high-tier Real-Time (FIFO) priorities."
    echo -e "  \033[1;37m• DAW Stack:\033[0m     Automatically detects Reaper/Wine/Yabridge and pins"
    echo -e "                    them to P-Cores with priority $RT_PRIO_DAW."
    echo -e "  \033[1;37m• Networking:\033[0m    Stops Wi-Fi power save and tightens Bluetooth polling"
    echo -e "                    to minimize interference during wireless MIDI/Audio."
    echo -e "--------------------------------------------------------------------------------"
    exit 0
}

# ---------------------------------------------------------
# 4. SUB-MODULES
# ---------------------------------------------------------
manage_pw() {
    local key=$1   # clock.force-quantum or clock.force-rate
    local value=$2

    if [[ -n "$value" ]]; then
        # Run as the real user to access the PipeWire session
        runuser -l "$REAL_USER" -c "pw-metadata -n settings 0 $key $value" >/dev/null 2>&1
        notify "PIPEWIRE: $key set to $value (as $REAL_USER)."
    fi
}

manage_cstates() {
    if [[ "$1" == "on" ]]; then
        sudo cpupower idle-set -D 0 >/dev/null 2>&1
        notify "CPU: C-States DISABLED."
    else
        sudo cpupower idle-set -E >/dev/null 2>&1
        notify "CPU: C-States ENABLED."
    fi
}

# ... [Other modules: manage_wifi_latency, manage_bt_latency, get_p_cores remain same] ...

manage_wifi_latency() {
    local p_state=$([[ "$1" == "on" ]] && echo "off" || echo "on")
    local interfaces=$(iw dev | awk '$1=="Interface"{print $2}')
    for dev in $interfaces; do sudo iw dev "$dev" set power_save "$p_state" 2>/dev/null; done
}

manage_bt_latency() {
    local hci_path="/sys/kernel/debug/bluetooth/hci0"
    if [[ "$1" == "on" && -d "$hci_path" ]]; then
        echo 12 | sudo tee "$hci_path/conn_max_interval" > /dev/null 2>&1
        echo 6 | sudo tee "$hci_path/conn_min_interval" > /dev/null 2>&1
        pgrep -x "bluetoothd" | xargs -r -I {} sudo chrt -f -p $RT_PRIO_BT {}
    elif [[ "$1" == "off" ]]; then
        pgrep -x "bluetoothd" | xargs -r -I {} sudo chrt -o -p 0 {}
    fi
}

get_p_cores() {
    local max_freq=$(cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq 2>/dev/null | sort -nr | head -n1)
    [[ -z "$max_freq" ]] && { echo "0-$(($(nproc) - 1))"; return; }
    grep -l "$max_freq" /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq | grep -oP 'cpu\K[0-9]+' | sort -n | xargs | tr ' ' ','
}

# ---------------------------------------------------------
# 5. MASTER EXECUTION
# ---------------------------------------------------------
manage_system_perf() {
    local action=$1
    if [[ "$action" == "on" ]]; then
        notify "INIT: Engaging Full Optimization..."
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo "performance" | sudo tee "$cpu" >/dev/null 2>&1; done
        for epp in /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference; do [[ -f "$epp" ]] && echo "performance" | sudo tee "$epp" >/dev/null; done
        echo "$SWAPPINESS_TARGET" | sudo tee /proc/sys/vm/swappiness > /dev/null
        echo "never" | sudo tee /sys/kernel/mm/transparent_hugepage/enabled > /dev/null
        manage_wifi_latency "on"
        manage_bt_latency "on"
        if command -v nvidia-settings &>/dev/null; then
            sudo nvidia-smi -pm 1 >/dev/null 2>&1
            nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=1" > /dev/null 2>&1
        fi
        local p_cores=$(get_p_cores)
        pgrep -f "irq/.*-xhci_hcd" | xargs -r -I {} sudo sh -c "taskset -pc 0 {} && chrt -f -p $RT_PRIO_USB {}" >/dev/null 2>&1
        pgrep -f "irq/.*-nvidia" | xargs -r -I {} sudo sh -c "taskset -pc 2 {} && chrt -f -p $RT_PRIO_NVIDIA {}" >/dev/null 2>&1
        pgrep -x "pipewire" | xargs -r -I {} sudo chrt -f -p $RT_PRIO_AUDIO {}
        local daw_pids=$(pgrep -f "reaper|yabridge|wineserver|\.exe" | grep -v "oom_reaper")
        for pid in $daw_pids; do
            local target_prio=$RT_PRIO_DAW
            [[ $(ps -p "$pid" -o comm=) == "wineserver" ]] && target_prio=$RT_PRIO_WINE
            sudo taskset -pc "$p_cores" "$pid" > /dev/null 2>&1
            sudo chrt -f -p "$target_prio" "$pid" 2>/dev/null
        done
    else
        notify "EXIT: Restoring Defaults..."
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo "schedutil" | sudo tee "$cpu" >/dev/null 2>&1 || echo "powersave" | sudo tee "$cpu" >/dev/null 2>&1; done
        echo "$RESTORE_SWAPPINESS" | sudo tee /proc/sys/vm/swappiness > /dev/null
        echo "always" | sudo tee /sys/kernel/mm/transparent_hugepage/enabled > /dev/null
        manage_wifi_latency "off"
        manage_bt_latency "off"
        if command -v nvidia-settings &>/dev/null; then
            nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=0" > /dev/null 2>&1
        fi
        pgrep -f "irq/.*" | xargs -r -I {} sudo taskset -pc "0-$(($(nproc)-1))" {} >/dev/null 2>&1
        pgrep -f "irq/.*-xhci|irq/.*-nvidia" | xargs -r -I {} sudo chrt -f -p $RESTORE_RT_PRIO_IRQ {} >/dev/null 2>&1
        pgrep -x "pipewire" | xargs -r -I {} sudo chrt -o -p $RESTORE_RT_PRIO_PROC {}
    fi
}

manage_scheduler() {
    local action=$1; local sched=${2:-scx_lavd}; local mode=${3:-gaming}
    if [[ "$action" == "on" ]]; then
        sudo scxctl stop >/dev/null 2>&1
        sleep 0.5
        notify "SCHED: Starting $sched ($mode)..."
        sudo scxctl start --sched "$sched" --mode "$mode" &
        sleep 1.0
    else
        notify "SCHED: Stopping scheduler..."
        sudo scxctl stop >/dev/null 2>&1
    fi
}

check_status() {
    echo "================================================================"
    echo "            PRO-AUDIO FULL STATUS REPORT"
    echo "================================================================"
    # Status also needs to run as user for pw-metadata
    local cur_q=$(runuser -l "$REAL_USER" -c "pw-metadata -n settings 0 clock.force-quantum" | grep -oP 'value:\K.*')
    local cur_r=$(runuser -l "$REAL_USER" -c "pw-metadata -n settings 0 clock.force-rate" | grep -oP 'value:\K.*')
    echo -e "PipeWire:     Buffer: ${cur_q:-unset} | Rate: ${cur_r:-unset}"
    echo -e "CPU Gov:      $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"
    echo -e "C-States:     $([[ $(sudo cpupower idle-info | grep -c "Disabled") -gt 0 ]] && echo -e "\033[1;31mDISABLED\033[0m" || echo -e "\033[1;32mENABLED\033[0m")"

    # WiFi Status Check (Comprehensive)
    local wifi_ps=$(iw dev | grep "power save" | awk '{print $3}' | sort -u)
    echo -e "Wi-Fi Power:  $([[ "$wifi_ps" == "off" ]] && echo -e "\033[1;31mDISABLED\033[0m" || echo -e "\033[1;32mENABLED\033[0m")"

    local scx_proc=$(pgrep -f scx_ | head -n 1)
    echo "RT Priorities (Active Check):"
    ps -eo rtprio,comm | awk -v rirq=$RESTORE_RT_PRIO_IRQ \
    '$1 > 0 && $2 ~ /reaper|pipewire|wine|nvidia|xhci|bluetooth/ {
        printf "            - %-15s (Prio: %s)\n", $2, $1
    }' | sort -u
    echo "================================================================"
}

# ---------------------------------------------------------
# 6. MAIN
# ---------------------------------------------------------
[[ $EUID -ne 0 ]] && { notify "ERROR: Run with sudo!"; exit 1; }

while getopts "o:c:s:m:b:r:Sh" opt; do
    case "$opt" in
        o) ACTION=$OPTARG ;;
        c) CSTATE_ACTION=$OPTARG ;;
        s) SCHED_NAME=$OPTARG ;;
        m) SCHED_MODE=$OPTARG ;;
        b) manage_pw "clock.force-quantum" "$OPTARG" ;;
        r) manage_pw "clock.force-rate" "$OPTARG" ;;
        S) check_status ; exit 0 ;;
        h|*) show_help ;;
    esac
done

[[ -n "$CSTATE_ACTION" ]] && manage_cstates "$CSTATE_ACTION"
if [[ "$ACTION" == "on" ]]; then
    manage_system_perf "on"
    manage_scheduler "on" "$SCHED_NAME" "$SCHED_MODE"
elif [[ "$ACTION" == "off" ]]; then
    manage_system_perf "off"
    manage_scheduler "off"
fi
