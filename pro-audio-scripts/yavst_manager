#!/usr/bin/env bash
# YaVST CLI Manager - Regular & Immutable Unified
set -Eeuo pipefail
IFS=$'\n\t'

# -------------------------
# Configuration & Paths
# -------------------------
HOME="${HOME:-/home/$(id -un)}"
BUNDLE_PATH="$HOME/.local/bin/YaVST"
DOWNLOAD_PATH="$HOME/Downloads"
YABRIDGE_ROOT="$BUNDLE_PATH/yabridge"
YABRIDGECTL_PATH="$YABRIDGE_ROOT/yabridgectl"

# Versions for Immutable Setup
WINE_VER="9.21"
YABRIDGE_VER="5.1.1"
WINEASIO_VER="1.3.0"
WINEASIO_REV="2.1"
WINE_BUILD_NAME="staging-tkg-amd64"

# -------------------------
# System Detection
# -------------------------
is_immutable() {
    # Checks for SteamOS or Fedora Silverblue/Kinoite/Bazzite
    if [[ -f /etc/steamos-release ]] || [[ -d /sysroot/ostree ]]; then
        return 0
    fi
    return 1
}

log_msg() { echo -e "\e[1;34m[$(date '+%H:%M:%S')]\e[0m $*"; }
error_exit() { echo -e "\e[1;31mERROR:\e[0m $*" >&2; exit 1; }

# -------------------------
# Feature: Wine & Yabridge Installation
# -------------------------
install_core() {
    if is_immutable; then
        log_msg "Immutable system detected. Installing portable bundle..."
        mkdir -p "$BUNDLE_PATH" "$DOWNLOAD_PATH"

        # Wine Installation
        local wine_file="wine-${WINE_VER}-${WINE_BUILD_NAME}.tar.xz"
        wget -c "https://github.com/Kron4ek/Wine-Builds/releases/download/${WINE_VER}/$wine_file" -O "$DOWNLOAD_PATH/$wine_file"
        rm -rf "$BUNDLE_PATH/bin" "$BUNDLE_PATH/lib" "$BUNDLE_PATH/share"
        tar -xJf "$DOWNLOAD_PATH/$wine_file" -C "$BUNDLE_PATH" --strip-components=1

        # Yabridge Installation
        local y_file="yabridge-${YABRIDGE_VER}.tar.gz"
        wget -c "https://github.com/robbert-vdh/yabridge/releases/download/${YABRIDGE_VER}/$y_file" -O "$DOWNLOAD_PATH/$y_file"
        rm -rf "$YABRIDGE_ROOT"
        mkdir -p "$YABRIDGE_ROOT"
        tar -xzf "$DOWNLOAD_PATH/$y_file" -C "$YABRIDGE_ROOT" --strip-components=1

        setup_env_script
    else
        log_msg "Regular distro detected. Please ensure 'wine' and 'yabridge' are installed via your package manager."
    fi
}

# -------------------------
# Feature: WineASIO Setup
# -------------------------
setup_wineasio() {
    local prefix="${WINEPREFIX:-$HOME/.wine}"

    if is_immutable; then
        log_msg "Immutable: Extracting WineASIO into portable bundle..."
        local pkg="wineasio-${WINEASIO_VER}-${WINEASIO_REV}-x86_64.pkg.tar.zst"
        wget -c "https://builds.garudalinux.org/repos/chaotic-aur/x86_64/$pkg" -O "$DOWNLOAD_PATH/$pkg"

        local temp=$(mktemp -d)
        tar -I zstd -xf "$DOWNLOAD_PATH/$pkg" -C "$temp"

        cp -v "$temp"/usr/lib/wine/x86_64-windows/wineasio64.dll "$prefix/drive_c/windows/system32/"
        mkdir -p "$BUNDLE_PATH/lib/wine/x86_64-unix"
        cp -v "$temp"/usr/lib/wine/x86_64-unix/wineasio64.dll.so "$BUNDLE_PATH/lib/wine/x86_64-unix/"
        rm -rf "$temp"
    else
        log_msg "Regular: Registering system-wide WineASIO..."
        local sys_dll64="/usr/lib/wine/x86_64-unix/wineasio64.dll.so"
        if [[ -f "$sys_dll64" ]]; then
            cp -v "$sys_dll64" "$prefix/drive_c/windows/system32/"
            wine regsvr32 wineasio64.dll
        else
            error_exit "System WineASIO DLL not found. Please install the wineasio package."
        fi
    fi
}

# -------------------------
# Environment Management
# -------------------------
setup_env_script() {
    local env_file="$HOME/.config/yavst/env.sh"
    mkdir -p "$(dirname "$env_file")"
    cat > "$env_file" <<EOF
export PATH="$BUNDLE_PATH/bin:$YABRIDGE_ROOT:\$PATH"
export WINELOADER="$BUNDLE_PATH/bin/wine"
export WINESERVER="$BUNDLE_PATH/bin/wineserver"
export WINEDLLPATH="$BUNDLE_PATH/lib/wine"
EOF
    log_msg "Environment script created at $env_file. Source this in your .bashrc or .zshrc."
}

# -------------------------
# Main Execution Logic
# -------------------------
show_help() {
    cat <<EOF
YaVST CLI Manager
Usage: $(basename "$0") [flag]

Commands:
  --install        Install/Update Wine & Yabridge (Portable on Immutable)
  --wineasio       Register WineASIO DLLs in current WINEPREFIX
  --add [path]     Add a VST directory to Yabridge
  --remove [path]  Remove a VST directory from Yabridge
  --sync           Manually trigger yabridgectl sync
  --list           List currently tracked VST directories
  --help           Show this message
EOF
}

# Determine which yabridgectl binary to use
if is_immutable; then
    YCTL="$YABRIDGECTL_PATH"
else
    YCTL=$(command -v yabridgectl || echo "yabridgectl")
fi

[[ $# -eq 0 ]] && { show_help; exit 0; }

case "$1" in
    --install)
        install_core
        ;;
    --wineasio)
        setup_wineasio
        ;;
    --add)
        shift
        [[ -z "${1:-}" ]] && error_exit "Please provide a path to add."
        "$YCTL" add "$1"
        "$YCTL" sync
        ;;
    --remove)
        shift
        [[ -z "${1:-}" ]] && error_exit "Please provide a path to remove."
        "$YCTL" rm "$1"
        "$YCTL" sync
        ;;
    --list)
        "$YCTL" list
        ;;
    --sync)
        "$YCTL" sync
        ;;
    --help|-h)
        show_help
        ;;
    *)
        error_exit "Unknown option: $1. Use --help for usage."
        ;;
esac
