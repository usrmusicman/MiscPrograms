#!/usr/bin/env bash
# YaVST Control Panel - System Wine/WineASIO/YaBridge
# Works on Arch/EndeavourOS/Fedora
set -Eeuo pipefail
IFS=$'\n\t'

HOME="${HOME:-/home/$(id -un)}"

# -------------------------
# Detect dialog tool
# -------------------------
if command -v zenity >/dev/null 2>&1; then
    DIALOG_TOOL="zenity"
else
    echo "Zenity not found. Please install zenity."
    exit 1
fi

if [[ "${XDG_CURRENT_DESKTOP:-}" == *KDE* ]] && command -v kdialog >/dev/null 2>&1; then
    DIALOG_TOOL="kdialog"
fi

# -------------------------
# Detect system binaries
# -------------------------
WINE_BIN=$(command -v wine64 || command -v wine) || {
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        kdialog --error "Wine not found. Please install wine or wine-staging."
    else
        zenity --error --text="Wine not found. Please install wine or wine-staging."
    fi
    exit 1
}

# System WineASIO DLLs
WINEASIO_DLL64="/usr/lib/wine/x86_64-unix/wineasio64.dll.so"
WINEASIO_DLL32="/usr/lib/wine/i386-unix/wineasio.dll.so"
[[ -f "$WINEASIO_DLL64" || -f "$WINEASIO_DLL32" ]] || {
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        kdialog --error "WineASIO DLL not found. Install wineasio package."
    else
        zenity --error --text="WineASIO DLL not found. Install wineasio package."
    fi
    exit 1
}

YABRIDGECTL_BIN=$(command -v yabridgectl) || {
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        kdialog --error "yabridgectl not found. Please install yabridge."
    else
        zenity --error --text="yabridgectl not found. Please install yabridge."
    fi
    exit 1
}

# -------------------------
# Helper functions
# -------------------------
show_info() {
    local msg="$1"
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        kdialog --msgbox "$msg"
    else
        zenity --info --text="$msg"
    fi
}

show_error() {
    local msg="$1"
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        kdialog --error "$msg"
    else
        zenity --error --text="$msg"
    fi
}

select_dir() {
    local dir=""
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        dir=$(kdialog --getexistingdirectory "$HOME" "Select Directory") || return
    else
        dir=$(zenity --file-selection --directory --title="Select Directory") || return
    fi
    [[ -d "$dir" ]] && echo "$dir"
}

select_vst_dir_kde() {
    # Optional: present common VST paths in KDE
    local common_dirs=(
        "$HOME/.vst"
        "$HOME/.vst3"
        "$HOME/.wine/drive_c/Program Files/VSTPlugins"
        "$HOME/.wine/drive_c/Program Files/Common Files/VST2"
        "$HOME/.wine/drive_c/Program Files/Common Files/VST3"
        "$HOME/VST"
        "$HOME/VST3"
    )

    local menu_args=()
    local i=1
    for d in "${common_dirs[@]}"; do
        [[ -d "$d" ]] || continue
        menu_args+=("$i" "$d")
        ((i++))
    done
    menu_args+=("0" "Choose manuallyâ€¦")

    local sel
    sel=$(kdialog --menu "Select VST Directory to Add" "${menu_args[@]}") || return

    if [[ "$sel" == "0" ]]; then
        select_dir
    else
        local idx=0
        for ((j=0;j<${#menu_args[@]};j+=2)); do
            [[ "${menu_args[j]}" == "$sel" ]] && idx=$((j+1))
        done
        echo "${menu_args[idx]}"
    fi
}

# -------------------------
# Core functions
# -------------------------
configure_winasio() {
    # Let user select WINEPREFIX
    local selected_prefix=""
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        selected_prefix=$(kdialog --getexistingdirectory "$HOME" "Select WINEPREFIX") || return
    else
        selected_prefix=$(zenity --file-selection --directory --title="Select WINEPREFIX") || return
    fi

    [[ -d "$selected_prefix" ]] || { show_error "Invalid directory selected"; return; }

    local target="$selected_prefix/drive_c/windows/system32/"
    mkdir -p "$target"

    local dll=""
    if [[ -f "$WINEASIO_DLL64" ]]; then
        dll="$WINEASIO_DLL64"
    elif [[ -f "$WINEASIO_DLL32" ]]; then
        dll="$WINEASIO_DLL32"
    fi

    cp -v "$dll" "$target/"
    show_info "WineASIO registered in prefix:\n$selected_prefix"
}

add_vst_dir() {
    local dir=""
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        dir=$(select_vst_dir_kde) || return
    else
        dir=$(select_dir) || return
    fi

    "$YABRIDGECTL_BIN" add "$dir"
    "$YABRIDGECTL_BIN" sync
    show_info "Added VST directory:\n$dir"
}

remove_vst_dir() {
    mapfile -t dirs < <("$YABRIDGECTL_BIN" list)
    [[ ${#dirs[@]} -gt 0 ]] || { show_info "No VST directories to remove"; return; }

    local sel=""
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        local menu_args=()
        for i in "${!dirs[@]}"; do
            menu_args+=("$i" "${dirs[$i]}")
        done
        sel=$(kdialog --menu "Select VST directory to remove" "${menu_args[@]}") || return
    else
        local zenity_input=()
        for i in "${!dirs[@]}"; do
            zenity_input+=("$i" "${dirs[$i]}")
        done
        sel=$(zenity --list --title="Remove VST directory" --column="Index" --column="Directory" "${zenity_input[@]}") || return
    fi

    [[ -n "${dirs[$sel]:-}" ]] || { show_error "Invalid selection"; return; }
    "$YABRIDGECTL_BIN" rm "${dirs[$sel]}"
    "$YABRIDGECTL_BIN" sync
    show_info "Removed VST directory:\n${dirs[$sel]}"
}

rescan_vsts() {
    "$YABRIDGECTL_BIN" sync
    show_info "VST rescan complete."
}

edit_yabridgectl_config() {
    local config_file="$HOME/.config/yabridgectl/config.toml"
    [[ -f "$config_file" ]] || { show_error "Config file not found at $config_file"; return; }
    xdg-open "$config_file" || show_error "Failed to open config file."
}

# -------------------------
# Main loop
# -------------------------
action=""
while true; do
    action=""
    if [[ "$DIALOG_TOOL" == "kdialog" ]]; then
        action=$(kdialog --menu "YaVST Control Panel" \
            "1" "Register WineASIO in Wine Prefix" \
            "2" "Add VST Directory" \
            "3" "Remove VST Directory" \
            "4" "Rescan VSTs" \
            "5" "Edit yabridgectl Config" \
            "6" "Exit") || continue
    else
        action=$(zenity --list --title="YaVST Control Panel" --column="Action" \
            "Register WineASIO in Wine Prefix" \
            "Add VST Directory" \
            "Remove VST Directory" \
            "Rescan VSTs" \
            "Edit yabridgectl Config" \
            "Exit") || continue
    fi

    case "$action" in
        "1"|"Register WineASIO in Wine Prefix") configure_winasio ;;
        "2"|"Add VST Directory") add_vst_dir ;;
        "3"|"Remove VST Directory") remove_vst_dir ;;
        "4"|"Rescan VSTs") rescan_vsts ;;
        "5"|"Edit yabridgectl Config") edit_yabridgectl_config ;;
        "6"|"Exit") break ;;
        *) show_error "Unknown action: $action" ;;
    esac
done
